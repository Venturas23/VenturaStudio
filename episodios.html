<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Episódios</title>
    <link rel="stylesheet" href="styles/episodio.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
       const arquivosM3U = ['js/Lista/M3U/SERIES/Séries Geral.m3u'];
       let episodios = [];
       let episodioAtualIndex = 0;

       async function carregarEpisodios() {
           const urlParams = new URLSearchParams(window.location.search);
           const serie = urlParams.get('serie');
           if (!serie) {
               document.getElementById('episodiosList').textContent = 'Nenhuma série selecionada.';
               return;
           }
           document.title = `Episódios de ${serie}`;
           document.getElementById('tituloSerie').textContent = `Episódios de ${serie}`;

           for (const arquivo of arquivosM3U) {
               try {
                   const response = await fetch(arquivo);
                   if (!response.ok) continue;
                   const m3uText = await response.text();
                   exibirEpisodiosDaSerie(m3uText, serie);
               } catch (error) {
                   console.error(`Erro ao carregar o arquivo ${arquivo}:`, error);
               }
           }

           const ultimoEpisodio = localStorage.getItem(`ultimoEpisodio_${serie}`);
           if (ultimoEpisodio) {
               const ultimoIndex = episodios.findIndex(ep => ep.link === ultimoEpisodio);
               if (ultimoIndex !== -1) {
                   episodioAtualIndex = ultimoIndex;
                   await reproduzirVideo(episodios[episodioAtualIndex].link);
               }
           }
       }

       function exibirEpisodiosDaSerie(m3uText, serie) {
           const linhas = m3uText.split("\n");
           const episodiosList = document.getElementById('episodiosList');
           episodiosList.innerHTML = '';

           linhas.forEach((linha, index) => {
               linha = linha.trim();
               if (linha.startsWith("#EXTINF")) {
                   const [, nome] = linha.split(",");
                   const match = nome.match(/^(.*) \((\d{4})\) (S\d+ E\d+)/);
                   if (match) {
                       const [_, serieNome, ano, temporadaEp] = match;
                       if (serieNome.trim() === serie.trim()) {
                           const link = linhas[index + 1]?.trim();
                           if (link && !link.startsWith("#")) {
                               const episodioObj = { nome: temporadaEp, link: link };
                               episodios.push(episodioObj);
                               const episodioLink = document.createElement("a");
                               episodioLink.href = link;
                               episodioLink.textContent = `${temporadaEp} (${ano})`;
                               episodioLink.classList.add("episodio");
                               episodioLink.addEventListener("click", (e) => {
                                   e.preventDefault();
                                   episodioAtualIndex = episodios.indexOf(episodioObj);
                                   reproduzirVideo(link);
                               });
                               episodiosList.appendChild(episodioLink);
                           }
                       }
                   }
               }
           });
           if (episodios.length === 0) {
               episodiosList.textContent = 'Nenhum episódio encontrado para esta série.';
           }
       }

       async function reproduzirVideo(url) {
           try {
               const response = await fetch(url);
               if (!response.ok) throw new Error(`Falha ao buscar vídeo em ${url}`);
               const finalLink = await response.text();
               const videoUrl = extrairUrlDoVideo(finalLink); // Adaptações podem ser necessárias
               
               const player = Plyr.setup('#videoPlayer')[0];
               player.source = { type: 'video', sources: [{ src: videoUrl, type: 'video/mp4' }] };
               player.play();

               const urlParams = new URLSearchParams(window.location.search);
               const serie = urlParams.get('serie');
               localStorage.setItem(`ultimoEpisodio_${serie}`, url);
           } catch (error) {
               console.error('Erro ao reproduzir vídeo:', error);
           }
       }

       function extrairUrlDoVideo(responseText) {
           // Modifique aqui para extrair corretamente a URL do vídeo do HTML/texto retornado
           const regex = /(http[^\s]+)/;
           const match = responseText.match(regex);
           return match ? match[0] : null;
       }

       document.addEventListener('DOMContentLoaded', carregarEpisodios);
    </script>
</head>
<body>
    <nav class="Barra-Lateral">
        <!-- Conteúdo da barra lateral -->
    </nav>
    <div class="header">
        <h1 class="Lista-Filmes">Lista de Séries</h1>
    </div>
    <div class="Video">
        <h1 class="tituloSerie" id="tituloSerie"></h1>
        <div class="episodiosList" id="episodiosList"></div>
    </div>
    <div class="plyr__video-embed" id="playerContainer">
        <video id="videoPlayer" controls playsinline></video>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>
</body>
</html>
